#!/usr/bin/env node

import { Command } from 'commander';
import { initCommand } from '../src/commands/init.js';
import { addSectionCommand } from '../src/commands/add-section.js';
import { removeSectionCommand } from '../src/commands/remove-section.js';
import { moveSectionCommand } from '../src/commands/move-section.js';
import { createComponentCommand } from '../src/commands/create-component.js';
import { removeComponentCommand } from '../src/commands/remove-component.js';
import { listSectionsCommand } from '../src/commands/list-sections.js';
import { validateStateCommand } from '../src/commands/validate-state.js';
import { statusCommand } from '../src/commands/status.js';
import { syncCommand } from '../src/commands/sync.js';
import { adoptCommand } from '../src/commands/adopt.js';
import { upgradeConfigCommand } from '../src/commands/upgrade-config.js';
import { normalizeStateCommand } from '../src/commands/normalize-state.js';

const program = new Command();

program
  .name('textor')
  .description('Safe, deterministic scaffolding and refactoring tool for Astro projects')
  .version('1.0.0');

program
  .command('init')
  .description('Initialize Textor configuration')
  .option('--force', 'Overwrite existing configuration')
  .option('--quiet', 'Skip printing full default configuration')
  .action(initCommand);

program
  .command('add-section [route] [featurePath]')
  .description('Create a route + feature binding (route optional for standalone features)')
  .option('--preset <name>', 'Scaffolding preset (minimal, standard, senior)')
  .option('--layout <name>', 'Layout component name (use "none" for no layout)')
  .option('--name <name>', 'Section name for state tracking')
  .option('--endpoint', 'Create an API endpoint (.ts) instead of an Astro page')
  .option('--api', 'Create api directory')
  .option('--services', 'Create services directory')
  .option('--schemas', 'Create schemas directory')
  .option('--hooks', 'Create hooks directory')
  .option('--context', 'Create context directory')
  .option('--tests', 'Create tests directory')
  .option('--types', 'Create types directory')
  .option('--readme', 'Create README.md')
  .option('--stories', 'Create Storybook stories')
  .option('--index', 'Create index.ts')
  .option('--no-sub-components-dir', 'Skip creating sub-components directory')
  .option('--no-scripts-dir', 'Skip creating scripts directory')
  .option('--prop <key=value>', 'Layout property', (val, memo) => {
    const [key, ...rest] = val.split('=');
    memo[key] = rest.join('=');
    return memo;
  }, {})
  .option('--dry-run', 'Show what would be created without creating')
  .option('--force', 'Overwrite existing files')
  .action(addSectionCommand);

program
  .command('remove-section <route> [featurePath]')
  .description('Remove a section (featurePath optional if using state)')
  .option('--keep-feature', 'Keep the feature module')
  .option('--keep-route', 'Keep the route file')
  .option('--accept-changes', 'Allow removal of modified files')
  .option('--dry-run', 'Show what would be deleted without deleting')
  .option('--force', 'Delete files even if not generated by Textor')
  .action(removeSectionCommand);

program
  .command('move-section')
  .description('Move a section')
  .argument('<fromRoute>', 'Source route or section name')
  .argument('<fromFeatureOrToRoute>', 'Source feature path OR Destination route (if using state)')
  .argument('[toRoute]', 'Destination route')
  .argument('[toFeature]', 'Destination feature path')
  .option('--keep-feature', 'Only move route, not feature')
  .option('--accept-changes', 'Allow moving of modified files')
  .option('--scan', 'Enable repo-wide import updates')
  .option('--force', 'Overwrite existing files')
  .option('--dry-run', 'Show what would be moved without moving')
  .action(moveSectionCommand);

program
  .command('create-component <componentName>')
  .description('Create a reusable UI component')
  .option('--preset <name>', 'Scaffolding preset (minimal, standard, senior)')
  .option('--api', 'Create api directory')
  .option('--services', 'Create services directory')
  .option('--schemas', 'Create schemas directory')
  .option('--readme', 'Create README.md')
  .option('--stories', 'Create Storybook stories')
  .option('--no-context', 'Skip creating context file')
  .option('--no-hook', 'Skip creating hook file')
  .option('--no-tests', 'Skip creating test file')
  .option('--no-types', 'Skip creating types file')
  .option('--no-config', 'Skip creating config file')
  .option('--no-constants', 'Skip creating constants file')
  .option('--no-sub-components-dir', 'Skip creating sub-components directory')
  .option('--dry-run', 'Show what would be created without creating')
  .option('--force', 'Overwrite existing files')
  .action(createComponentCommand);

program
  .command('remove-component <name>')
  .description('Remove a reusable UI component')
  .option('--accept-changes', 'Allow removal of modified files')
  .option('--dry-run', 'Show what would be deleted without deleting')
  .option('--force', 'Delete files even if not generated by Textor')
  .action(removeComponentCommand);

program
  .command('list-sections')
  .description('List all Textor-managed sections')
  .action(listSectionsCommand);

program
  .command('status')
  .description('Show drift between state and disk')
  .action(statusCommand);

program
  .command('validate-state')
  .description('Validate that the state file matches the project files')
  .option('--fix', 'Try to fix state by re-hashing modified files (requires signatures to match)')
  .action(validateStateCommand);

program
  .command('sync')
  .description('Synchronize the state with the actual files in managed directories')
  .option('--include-all', 'Include all files in managed directories, even without Textor signature')
  .option('--force', 'Update hashes for modified files even without Textor signature')
  .option('--dry-run', 'Show what would be changed without applying')
  .action(syncCommand);

program
  .command('adopt [path]')
  .description('Adopt untracked files into Textor state, adding signatures')
  .option('--all', 'Adopt all untracked files in managed directories')
  .option('--dry-run', 'Show what would be adopted without applying')
  .action(adoptCommand);

program
  .command('upgrade-config')
  .description('Upgrade Textor configuration to the latest version')
  .option('--dry-run', 'Show the upgraded config without writing to disk')
  .action(upgradeConfigCommand);

program
  .command('normalize-state')
  .description('Normalize state paths to be project-relative')
  .option('--dry-run', 'Show the normalized state without writing to disk')
  .action(normalizeStateCommand);

program.parse();
